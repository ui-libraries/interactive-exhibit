<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Interactive Exhibit</title>
    <link rel="icon" href="data:," />
    <link rel="stylesheet" href="css/style.css" />
    <!-- Load Meshopt (ESM), then model-viewer (ESM), to ensure decoder availability -->
    <script type="module">
      try {
        const mod = await import('https://unpkg.com/three@0.128.0/examples/jsm/libs/meshopt_decoder.module.js');
        const MeshoptDecoder = mod.MeshoptDecoder;
        if (MeshoptDecoder && MeshoptDecoder.ready && typeof MeshoptDecoder.ready.then === 'function') {
          await MeshoptDecoder.ready;
        }
        self.MeshoptDecoder = MeshoptDecoder;
      } catch (e) {
        console.error('Failed to load MeshoptDecoder ESM', e);
      }
      await import('https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js');
    </script>
    
    
</head>
<body>
    <div id="app"></div>

    <script>
        // Slides data
        const slides = [
            {
                title: "The Remmelin",
                description: "A multi-layered anatomical illustration. Explore each layer by cycling through the images.",
                media: [
                    { type: "video", src: "assets/videos/remmelin/remmelin_man.mp4", loop: true },
                    { type: "video", src: "assets/videos/remmelin/remmelin_plate_clouds.mp4", loop: true },
                    { type: "video", src: "assets/videos/remmelin/remmelin_plate_eye.mp4", loop: true },
                    { type: "video", src: "assets/videos/remmelin/remmelin_plate_man.mp4", loop: true },
                    { type: "video", src: "assets/videos/remmelin/remmelin_plate_torso.mp4", loop: true },
                    { type: "video", src: "assets/videos/remmelin/remmelin_plate_woman.mp4", loop: true },
                    { type: "video", src: "assets/videos/remmelin/remmelin_woman.mp4", loop: true }
                ]
            },
            {
                title: "Fragmentos",
                description: "A poetic video work exploring the ephemeral nature of rain.",
                media: [
                    { type: "video", src: "assets/videos/fragmentos/fragmentos.mp4", loop: true }
                ]
            },
            {
                title: "Tunnel Book",
                description: "Interactive 3D model viewer. Drag to rotate, pinch to zoom.",
                media: [
                    { type: "3d", src: "assets/models/book.glb" }
                ]
            },
            {
                title: "The Deep",
                description: "A video journey into the mysterious depths of the ocean.",
                media: [
                    { type: "video", src: "assets/videos/thedeep/thedeep.mp4", loop: true }
                ]
            }
        ];

        // Removed legacy Three.js viewer; model-viewer is used instead for 3D

        // Main app logic
        const app = document.getElementById('app');
        let currentSlide = 0;
        let currentMedia = 0;

        function render() {
            const slide = slides[currentSlide];
            const mediaItem = slide.media[currentMedia];

            let mediaHtml = '';
            const absoluteMediaUrl = (() => {
                try {
                    const base = window.location.origin;
                    const path = mediaItem.src.startsWith('http') ? mediaItem.src : `${base}/${mediaItem.src}`;
                    return encodeURIComponent(path);
                } catch (_) {
                    return encodeURIComponent(mediaItem.src);
                }
            })();
            if (mediaItem.type === 'image') {
                mediaHtml = `<img class="media-asset" src="${mediaItem.src}" alt="${slide.title}" />`;
                            } else if (mediaItem.type === 'video') {
                    const loopAttr = mediaItem.loop ? 'loop' : '';
                    const volumeAttr = mediaItem.src.includes('thedeep.mp4') ? 'data-volume="0.7"' : '';
                    mediaHtml = `<video class="media-asset" src="${mediaItem.src}" controls autoplay preload="auto" width="100%" height="100%" ${loopAttr} ${volumeAttr}></video>`;
            } else if (mediaItem.type === 'youtube') {
                mediaHtml = `
                    <iframe
                        class="media-asset"
                        width="100%"
                        height="100%"
                        src="https://www.youtube.com/embed/${mediaItem.src}?autoplay=1&controls=1&rel=0"
                        title="YouTube video player"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                    ></iframe>
                `;
            } else if (mediaItem.type === '3d') {
                const cropTopPx = 56;
                const cropBottomPx = 64;
                const cropTotalPx = cropTopPx + cropBottomPx;
                const externalViewerSrc = (() => {
                    const modelAbs = new URL(mediaItem.src, window.location.href).toString();
                    const proxied = 'https://cors.isomorphic-git.org/' + modelAbs;
                    return 'https://gltf-viewer.donmccurdy.com/#model=' + encodeURIComponent(proxied) + '&kiosk=1';
                })();
                mediaHtml = `
                  <div style="position:relative;width:100%;height:100%;overflow:hidden;background:#f0f0f0;border-radius:4px;">
                    <iframe
                      class="media-asset"
                      style="position:absolute;top:-${cropTopPx}px;left:0;width:100%;height:calc(100% + ${cropTotalPx}px);border:0;background:#f0f0f0;"
                      src="${externalViewerSrc}"
                      allow="autoplay; fullscreen"
                    ></iframe>
                    <div style="position:absolute;right:12px;bottom:12px;padding:6px 10px;background:rgba(0,0,0,0.55);color:#fff;font:500 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;border-radius:4px;">
                      Drag: Rotate Â· Pinch/Wheel: Zoom
                    </div>
                  </div>
                `;
            }

            app.innerHTML = `
                <div class="split-container">
                    <div class="logo-container">
                        <img src="assets/images/logo.png" alt="Logo" />
                    </div>
                    <div class="media-side">
                        <div class="media-display">
                            ${mediaHtml}
                        </div>
                        <div class="desc-container">
                            <button id="prev-slide">
                                <img src="assets/images/back-button.svg" alt="Previous Work" />
                            </button>
                            <div class="desc-content">
                                <h2>${slide.title}</h2>
                                <p>${slide.description}</p>
                                <div class="slide-controls">
                                    <span class="counter">Work ${currentSlide + 1} of ${slides.length}</span>
                                </div>
                            </div>
                            <button id="next-slide">
                                <img src="assets/images/next-button.svg" alt="Next Work" />
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Mount model-viewer after Meshopt and custom element are ready
            // No JS init needed for external viewer iframe
            
            // Set volume for specific videos after they load
            if (mediaItem.type === 'video') {
                setTimeout(() => {
                    const video = document.querySelector('.media-asset');
                    if (video && video.tagName === 'VIDEO') {
                        if (mediaItem.src.includes('thedeep.mp4')) {
                            video.volume = 0.7; // 30% lower volume
                        }
                    }
                }, 200);
            }
            


            // Note: Media controls are not included in the current layout
            // Only slide navigation controls are used

            document.getElementById('prev-slide').onclick = () => {
                currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                currentMedia = 0;
                render();
            };
            document.getElementById('next-slide').onclick = () => {
                currentSlide = (currentSlide + 1) % slides.length;
                currentMedia = 0;
                render();
            };
        }

        // Start the app
        render();
    </script>
</body>
</html> 